<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="assets/css/bootstrap.css">
  <link rel="icon" href="favicon.png" type="image/png" />

  <title>Rental Mobil</title>
  <style>
    body {
      margin-bottom: 50px;
    }

    .nav-link {
      font-weight: bold;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 15px;
    }

    .card-title {
      text-align: center;
      font-weight: bold;
    }

    .card-text {
      font-weight: lighter;
      text-align: center;
    }

    .card-group {
      gap: 10px;
      max-width: 400px;
      padding: 5px;
      margin-top: 2px;

    }

    [class*="card-group"] {
      width: 100%;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#"
      style="font-weight: bold; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
      <img src="images/car.png" width="30" height="30" class="d-inline-block align-top" alt="">
      RentalMobil
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
      aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="index.html">Home <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="#">Peminjaman</a>
        </li>
        <li class="nav-item"><a class="nav-link" href="mobil.html">Daftar Mobil</a></li>
      </ul>
    </div>
  </nav>
  <div class="container">
    <h1 class="display-4"
      style="font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;font-weight:bold; text-align: center; margin-top: 40px;">
      Peminjaman Mobil</h1>
    <div id="alertBerhasil"></div>

    <div class="content pt-2">
      <div class="container-fluid">
        <button class="btn btn-primary mb-3" data-toggle="modal" data-target="#Tambah">
          Tambah data rental
        </button>

        <div id="content-peminjaman" class="mt-3"></div>
      </div>

    </div>
  </div>
  <!-- Tambah -->
  <div class="modal fade" id="Tambah" tabindex="-1" aria-labelledby="labelTambah" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="labelTambah">Tambah Data Peminjam</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form action="">
            <div class="mb-3">
              <div class="form-group">
                <label for="nama">Nama</label>
                <input type="text" class="form-control" id="nameTambah" aria-describedby="emailHelp" required />
              </div>
            </div>
            <div class="form-group">
              <label for="alamatTambah">Alamat</label>
              <textarea type="text" class="form-control" id="alamatTambah" aria-describedby="emailHelp" cols="20"
                rows="0"></textarea>

              <div class="form-group">
                <label for="nikTambah">NIK</label>
                <input type="number" class="form-control" id="nikTambah" aria-describedby="emailHelp" />

                <div class="form-group">
                  <label for="telpTambah">No. Telp</label>
                  <input type="number" class="form-control" id="telpTambah" aria-describedby="emailHelp" />

                  <div class="form-group">
                    <label for="inputMobil">Pilih Mobil</label>
                    <select id="inputMobil" class="form-control">
                    </select>
                  </div>

                  <div class="form-group">
                    <label for="totalTambah">Total Pinjam (hari)</label>
                    <input type="number" class="form-control" id="totalTambah" aria-describedby="emailHelp" />
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            Close
          </button>
          <button type="button" class="btn btn-primary" onclick="Savedata()">
            Save
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit-->
  <div class="modal fade" id="modalEditData" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Edit</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="close"><span
              aria-hidden="true">&times;</span></button>
        </div>

        <div class="modal-body">
          <form action="">
            <div class="mb-3">
              <input type="hidden" id="idEdit" />
              <label for="name">Nama</label>
              <input type="text" class="form-control" id="name" aria-describedby="emailHelp" required />
            </div>
            <div class="mb-3">
              <label for="alamat" class="form-control">Alamat</label>
              <textarea class="form-control" id="alamat" rows=""></textarea>
            </div>
            <div class="mb-3">
              <label for="number" class="form-label">No HP</label>
              <input type="number" class="form-control" id="number" aria-describedby="emailHelp" min="0" required />
            </div>
            <div class="mb-3">
              <input type="hidden" id="id" />
              <label for="NIK">NIK</label>
              <input type="text" class="form-control" id="NIK" aria-describedby="emailHelp" required />
            </div>
            <div class="mb-3">
              <label for="mobil" class="form-label">pilih mobil</label>
              <select class="form-select" aria-label="Default select example" id="mobil">
              </select>
            </div>
            <div class="form-group">
              <label for="totalEdit">Status Pinjam</label>
              <select id="inputStatusEdit" class="form-control">
                <option value="Selesai">Selesai</option>
                <option value="Belum Selesai">Belum Selesai</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="totalPinjam" class="form-label">Total rental</label>
              <input class="form-control" type="number" id="totalPinjamEdit" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            Close
          </button>
          <button type="button" class="btn btn-primary" onclick="saveEditData()">
            Save changes
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Detail -->
  <div class="modal fade" id="modalDetailData" tabindex="-1" aria-labelledby="labelmodalDetailData" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="labelmodalDetailData">Detail Peminjaman</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" id="cardBodyDetailPeminjaman"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" onclick="hapusData()" data-dismiss="modal">
            Hapus
          </button>
          <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#modalEditData"
            onclick="showEditData()" data-dismiss="modal">
            Edit
          </button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            Tutup
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="row justify-content-md-center">
    <div class="col-md-4">

      <script>
        function numberWithCommas(x) {
          return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function dataMobil() {
          let data = localStorage.getItem("dataMobil");
          data = JSON.parse(data);

          let mobil = document.getElementById("inputMobil");

          if (data == null) {
            mobil.innerHTML = `
          <option selected>Pilih</option>
          `;

            return;
          }

          let option = `
            <option selected>Pilih</option>
            `;
          for (let i = 0; i < data.data.length; i++) {
            if (data.data[i].status != "available") {
              continue;

            }
            option += `
          <option value="${data.data[i].id}">${data.data[i].name}</option>
          `;
          }
          document.getElementById("inputMobil").innerHTML = option;
        }

        dataMobil();
        function showData(reload = false) {
          this.dataMobil();
          let data = localStorage.getItem("dataPeminjaman");
          data = JSON.parse(data);

          let tabelPeminjaman = document.getElementById("content-peminjaman");

          if (data == null || data.length == 0) {
            tabelPeminjaman.innerHTML = `
          <div class="alert alert-warning">
            Data Kosong
          </div>
          `;
            return;
          }

          if (reload == true || data != null) {
            tabelPeminjaman.innerHTML = `
          <table class="table table-striped" id="tabel-peminjaman"></table>
          `;
          }
          let nomor = 1;
          let tabel = `
            <tr>
            <th>No</th>
            <th>Nama</th>
            <th>Mobil</th>
            <th>Status</th>
            <th>Aksi</th>
          </tr>
            `;
          let dataMobil = localStorage.getItem("dataMobil");
          dataMobil = JSON.parse(dataMobil);
          for (let i = 0; i < data.length; i++) {
            //find data mobil
            dataMobil = localStorage.getItem("dataMobil");
            dataMobil = JSON.parse(dataMobil);

            dataMobil = dataMobil.data.find((item) => item.id == data[i].mobil);

            if (dataMobil == null) {
              dataMobil = {
                name: "Mobil tidak ditemukan",
                status: "Not available"
              }
            }


            if (data[i].status == "Selesai") {
              dataMobil = {
                name: data[i].mobil,
              }
            }
            tabel += `
             
              <tr>
            <td>${nomor}</td>
            <td>${data[i].nama}</td>
            <td>${dataMobil.name}</td>
            <td class="${data[i].status == "Selesai" ? "text-success" : "text-danger"}"
            >${data[i].status}</td>
            <td>
              <button class="btn btn-primary" onclick="detailData(${i})" data-toggle="modal" data-target="#modalDetailData">Detail</button>
            </td>
          </tr>
              `;
          }
          document.getElementById("tabel-peminjaman").innerHTML = tabel;
        }

        function Savedata() {
          let nama = document.getElementById("nameTambah").value;
          let alamat = document.getElementById("alamatTambah").value;
          let telp = document.getElementById("telpTambah").value;
          let nik = document.getElementById("nikTambah").value;
          let mobil = document.getElementById("inputMobil").value;
          let total = document.getElementById("totalTambah").value;

          let data = localStorage.getItem("dataPeminjaman");
          data = JSON.parse(data);

          if (data == null) {
            data = [];
          }
          let dataMobil = localStorage.getItem("dataMobil");
          dataMobil = JSON.parse(dataMobil);

          if (dataMobil == null) {
            dataMobil = [];
          }

          let mobilIndex = dataMobil.data.findIndex((item) => item.id == mobil);
          dataMobil.data[mobilIndex].status = "Not available";

          localStorage.setItem("dataMobil", JSON.stringify(dataMobil));

          let dataBaru = {
            nama: nama,
            alamat: alamat,
            telp: telp,
            nik: nik,
            mobil: mobil,
            totalHari: total,
            totalBayar: parseInt(dataMobil.data[mobilIndex].harga) * total,
            status: "Belum Selesai",
          };
          data.push(dataBaru);

          localStorage.setItem("dataPeminjaman", JSON.stringify(data));

          showData(true);

          $("#Tambah").modal("hide");

          let alert = `
              <div class="alert alert-success" role="alert">
              Data berhasil ditambahkan
              </div>
              `;
          document.getElementById("alertBerhasil").innerHTML = alert;

          setTimeout(() => {
            document.getElementById("alertBerhasil").innerHTML = "";
          }, 3000);
        }

        function detailData(id) {
          let data = localStorage.getItem("dataPeminjaman");
          data = JSON.parse(data);
          let mobilName = "";

          if (data[id].status != "Selesai") {
            let dataMobil = localStorage.getItem("dataMobil");
            dataMobil = JSON.parse(dataMobil);

            let mobilIndex = dataMobil.data.findIndex(
              (item) => item.id == data[id].mobil
            );
            mobilName = dataMobil.data[mobilIndex].name;
          } else {
            mobilName = data[id].mobil;
          }
          let cardBody = `
          <div class="card">
            <div class="card-body">
              <input type="hidden" id="idDetail" value="${id}">
              <h5 class="card-title">Nama : ${data[id].nama}</h5>
              <h5 class="card-text">Alamat : ${data[id].alamat}</h5>
              <p class="card-text">No. Telp : ${data[id].telp}</p>
              <p class="card-text">NIK : ${data[id].nik}</p>
              <p class="card-text">Mobil : ${mobilName}</p>
              <p class="card-text">Total Hari : ${data[id].totalHari}</p>
              <p class="card-text">Total Bayar : Rp. ${numberWithCommas(
            data[id].totalBayar
          )}</p>
              <p class="card-text">Status : ${data[id].status}</p>
            </div>
          </div>
        `;

          document.getElementById("cardBodyDetailPeminjaman").innerHTML = cardBody;
        }
        function hapusData() {
          let id = document.getElementById("idDetail").value;

          let data = localStorage.getItem("dataPeminjaman");
          data = JSON.parse(data);

          if (data[id].status != "Selesai") {
            let dataMobil = localStorage.getItem("dataMobil");
            dataMobil = JSON.parse(dataMobil);

            let mobilIndex = dataMobil.data.findIndex(
              (item) => item.id == data[id].mobil
            );

            dataMobil.data[mobilIndex].status = "available";

            localStorage.setItem("dataMobil", JSON.stringify(dataMobil));
          }

          data.splice(id, 1);

          localStorage.setItem("dataPeminjaman", JSON.stringify(data));

          showData(true);
          dataMobil();

          $("#modalDetailData").modal("hide");

          let alert = `
        <div class="alert alert-success" role="alert">
          Data berhasil dihapus
        </div>
        `;
          document.getElementById("alertBerhasil").innerHTML = alert;

          setTimeout(() => {
            document.getElementById("alertBerhasil").innerHTML = "";
          }, 3000);
        }

        function saveEditData() {
          let id = document.getElementById("idEdit").value;
          let nama = document.getElementById("name").value;
          let alamat = document.getElementById("alamat").value;
          console.log(alamat);
          let telp = document.getElementById("number").value;
          console.log(telp);
          let nik = document.getElementById("NIK").value;
          console.log(nik);
          let mobil = document.getElementById("mobil").value;

          let total = document.getElementById("totalPinjamEdit").value;
          console.log(total);
          let status = document.getElementById("inputStatusEdit").value;
          console.log(status);
          let data = localStorage.getItem("dataPeminjaman");
          data = JSON.parse(data);

          let dataMobil = localStorage.getItem("dataMobil");
          dataMobil = JSON.parse(dataMobil);

          let mobilIndex = dataMobil.data.findIndex((item) => item.id == mobil);


          if (data[id].status == "Selesai" && data[id].mobil != mobil && status == "Selesai") {
            let alert = `
          <div class="alert alert-danger" role="alert">
            Mobil tidak dapat diubah karena status sudah selesai, ubah status menjadi belum selesai terlebih dahulu
          </div>
          `;
            document.getElementById("alertBerhasil").innerHTML = alert;

            setTimeout(() => {
              document.getElementById("alertBerhasil").innerHTML = "";
            }, 5000);
            return;
          }

          if (data[id].mobil != mobil && data[id].status != "Selesai") {
            let mobilIndexLama = dataMobil.data.findIndex(
              (item) => item.id == data[id].mobil
            );
            dataMobil.data[mobilIndexLama].status = "available";
          }

          if ((data[id].status != "Selesai" && status == "Selesai") && data[id].mobil != mobil) {
            const idMobilLama = data[id].mobil;
            console.log("index lama : " + idMobilLama);
            const mobilIndexLama = dataMobil.data.findIndex(
              (item) => item.id == idMobilLama
            );
            dataMobil.data[mobilIndexLama].status = "available";
          }
          if (status != "Selesai") {
            dataMobil.data[mobilIndex].status = "Not available";
          } else {
            dataMobil.data[mobilIndex].status = "available";
          }

          localStorage.setItem("dataMobil", JSON.stringify(dataMobil));

          let totalBayar;
          if (status == "Selesai") {
            totalBayar = data[id].totalBayar;
            mobilIndex = dataMobil.data.findIndex(
              (item) => item.id == data[id].mobil
            );
            console.log("Index baru : " + mobilIndex);
            dataMobil.data[mobilIndex].status = "available";

            localStorage.setItem("dataMobil", JSON.stringify(dataMobil));

            mobil = dataMobil.data[mobilIndex].name;
          } else {
            totalBayar = parseInt(dataMobil.data[mobilIndex].harga) * total;
          }
          let dataBaru = {
            nama: nama,
            alamat: alamat,
            telp: telp,
            nik: nik,
            mobil: mobil,
            totalHari: total,
            totalBayar: totalBayar,
            status: status,
          };

          data[id] = dataBaru;

          localStorage.setItem("dataPeminjaman", JSON.stringify(data));

          showData(true);

          $("#modalEditData").modal("hide");

          let alert = `
        <div class="alert alert-success" role="alert">
          Data berhasil diubah
        </div>
        `;

          document.getElementById("alertBerhasil").innerHTML = alert;

          setTimeout(() => {
            document.getElementById("alertBerhasil").innerHTML = "";
          }, 3000);

        }

        function showEditData() {
          let id = document.getElementById("idDetail").value;

          let data = localStorage.getItem("dataPeminjaman");
          data = JSON.parse(data);

          let dataMobil = localStorage.getItem("dataMobil");
          dataMobil = JSON.parse(dataMobil);

          let mobilIndex = dataMobil.data.findIndex(
            (item) => item.id == data[id].mobil
          );

          document.getElementById("idEdit").value = id;
          document.getElementById("name").value = data[id].nama;
          document.getElementById("alamat").value = data[id].alamat;
          document.getElementById("number").value = data[id].telp;
          document.getElementById("NIK").value = data[id].nik;



          let option = "";
          for (let i = 0; i < dataMobil.data.length; i++) {
            if (
              dataMobil.data[i].status != "available" &&
              dataMobil.data[i].id != data[id].mobil
            ) {
              continue;
            }
            option += `
          <option value="${dataMobil.data[i].id}" ${dataMobil.data[i].id == data[id].mobil ? "selected" : ""
              }>${dataMobil.data[i].name}</option>
          `;
          }
          document.getElementById("mobil").innerHTML = option;
          document.getElementById("totalPinjamEdit").value = data[id].totalHari;
          document.getElementById("inputStatusEdit").value = data[id].status;
        }

        showData();
      </script>


      <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
        crossorigin="anonymous"></script>

</body>

</html>